---
# Install Minification Tools
- name: Install terser globally for JavaScript minification
  npm:
    name: terser
    global: yes
    state: present
  become: yes

- name: Install csso-cli globally for CSS minification
  npm:
    name: csso-cli
    global: yes
    state: present
  become: yes

# JavaScript Minification
- name: Check if JavaScript files exist
  find:
    paths: /var/www/app/public/assets/scripts
    patterns: "*.js"
    excludes: "*.min.js"
  register: js_files
  become: yes

- name: Minify JavaScript files into main.min.js
  shell: |
    set -e
    terser public/assets/scripts/*.js \
      --compress \
      --mangle \
      --output public/assets/scripts/main.min.js
  args:
    chdir: /var/www/app
    creates: public/assets/scripts/main.min.js
  when: js_files.matched > 0
  become: yes

- name: Remove non-minified JavaScript files
  find:
    paths: /var/www/app/public/assets/scripts
    patterns: "*.js"
    excludes: "*.min.js"
  register: js_to_remove
  become: yes

- name: Delete non-minified JavaScript files
  file:
    path: "{{ item.path }}"
    state: absent
  loop: "{{ js_to_remove.files }}"
  when: js_to_remove.matched > 0
  become: yes

# CSS Minification
- name: Check if CSS files exist
  find:
    paths: /var/www/app/public/assets/styles
    patterns: "*.css"
    excludes: "*.min.css"
  register: css_files
  become: yes

- name: Minify CSS files into main.min.css
  shell: |
    set -e
    csso public/assets/styles/*.css \
      --output public/assets/styles/main.min.css
  args:
    chdir: /var/www/app
    creates: public/assets/styles/main.min.css
  when: css_files.matched > 0
  become: yes

- name: Remove non-minified CSS files
  find:
    paths: /var/www/app/public/assets/styles
    patterns: "*.css"
    excludes: "*.min.css"
  register: css_to_remove
  become: yes

- name: Delete non-minified CSS files
  file:
    path: "{{ item.path }}"
    state: absent
  loop: "{{ css_to_remove.files }}"
  when: css_to_remove.matched > 0
  become: yes

# Nginx Configuration
- name: Deploy nginx configuration from template
  template:
    src: ../templates/nginx.conf.j2
    dest: /etc/nginx/nginx.conf
    owner: root
    group: root
    mode: '0644'
    backup: yes
    validate: 'nginx -t -c %s'
  notify: reload nginx
  become: yes

- name: Ensure nginx service is enabled and started
  systemd:
    name: nginx
    state: started
    enabled: yes
  become: yes