user ubuntu;
worker_processes auto;
pid /run/nginx.pid;

events {
  worker_connections 1024;
  use epoll;
  multi_accept on;
}

http {
  ##############################################################################
  # BASIC SETTINGS
  ##############################################################################
  include mime.types;
  default_type application/octet-stream;
  
  sendfile on;
  tcp_nopush on;
  tcp_nodelay on;
  keepalive_timeout 30;
  types_hash_max_size 2048;
  server_tokens off;
  
  ##############################################################################
  # BUFFER CONFIGURATION
  ##############################################################################
  client_body_buffer_size 128k;
  client_max_body_size 16M;
  client_header_buffer_size 4k;
  large_client_header_buffers 4 16k;
  
  ##############################################################################
  # TIMEOUT CONFIGURATION
  ##############################################################################
  client_body_timeout 12;
  client_header_timeout 12;
  send_timeout 10;
  
  ##############################################################################
  # FILE CACHE CONFIGURATION
  ##############################################################################
  open_file_cache max=2000 inactive=60s;
  open_file_cache_valid 30s;
  open_file_cache_min_uses 2;
  open_file_cache_errors on;
  
  ##############################################################################
  # GZIP COMPRESSION
  ##############################################################################
  gzip on;
  gzip_vary on;
  gzip_proxied any;
  gzip_comp_level 6;
  gzip_min_length 256;
  gzip_disable "msie6";
  gzip_static on;
  gzip_types
    text/plain
    text/css
    text/javascript
    application/javascript
    application/json
    image/x-icon;
  
  ##############################################################################
  # PROXY CACHE CONFIGURATION
  ##############################################################################
  proxy_cache_path /var/cache/nginx 
    levels=1:2 
    keys_zone=STATIC:128m 
    inactive=12h 
    max_size=512m 
    use_temp_path=off;
  
  ##############################################################################
  # CORS MAPPING
  ##############################################################################
  map $request_uri $cors_origin {
    default "";
    ~^/leaderboards\?format=json "*";
    ~^/arenas\?format=json "*";
    /upload "*";
    /revoke_discord "*";
    /geolocation "*";
  }
  
  map $request_method $is_options {
    default 0;
    OPTIONS 1;
  }
  
  ##############################################################################
  # LOGGING CONFIGURATION
  ##############################################################################
  access_log /var/log/nginx/access.log;
  error_log /var/log/nginx/error.log crit;
  
  ##############################################################################
  # SSL/TLS CONFIGURATION
  ##############################################################################
  ssl_protocols TLSv1.2 TLSv1.3;
  ssl_ciphers "ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384";
  ssl_prefer_server_ciphers off;
  ssl_session_cache shared:SSL:10m;
  ssl_session_timeout 1440m;
  ssl_session_tickets off;
  ssl_stapling on;
  ssl_stapling_verify on;
  resolver 1.1.1.1 8.8.8.8 valid=300s;
  resolver_timeout 5s;
  
  ##############################################################################
  # HTTPS SERVER (HTTP/2 + HTTP/3)
  ##############################################################################
  server {
    # Listen directives
    listen 443 ssl reuseport;
    listen [::]:443 ssl reuseport;
    listen 443 quic reuseport;
    listen [::]:443 quic reuseport;
    
    http2 on;
    
    server_name hypersomnia.io www.hypersomnia.io;
    
    # SSL certificates
    ssl_certificate /etc/letsencrypt/live/hypersomnia.io/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/hypersomnia.io/privkey.pem;
    
    # HTTP/3 advertisement
    add_header Alt-Svc 'h3=":443"; ma=86400' always;
    
    # Security headers
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;
    
    # Canonical domain redirect (www -> non-www)
    if ($host != "hypersomnia.io") {
      return 301 https://hypersomnia.io$request_uri;
    }
    
    #--------------------------------------------------------------------------
    # STATIC REDIRECTS
    #--------------------------------------------------------------------------
    location = /press {
      return 301 https://github.com/TeamHypersomnia/PressKit/blob/main/README.md#intro;
    }
    
    location = /credits {
      return 301 https://teamhypersomnia.github.io/PressKit/credits;
    }
    
    location = /steam {
      return 301 https://store.steampowered.com/app/2660970/Hypersomnia/;
    }
    
    location = /discord {
      return 301 https://discord.com/invite/YC49E4G;
    }
    
    #--------------------------------------------------------------------------
    # ZIP FILE DOWNLOADS
    #--------------------------------------------------------------------------
    location ~* \.zip$ {
      root /var/www/html;
      default_type application/zip;
      add_header Content-Disposition "attachment";
      add_header Cache-Control "public, max-age=3600";
    }
    
    #--------------------------------------------------------------------------
    # STATIC ASSETS & FAVICON
    #--------------------------------------------------------------------------
    location ~ ^/(assets/.*|favicon\.ico|robots\.txt)$ {
      alias /var/www/app/public/$1;
      
      expires 1y;
      access_log off;
      
      add_header Cache-Control "public, immutable";
      add_header Access-Control-Allow-Origin "*" always;
      add_header Access-Control-Allow-Methods "GET, OPTIONS" always;
      
      proxy_cache STATIC;
      proxy_cache_valid 200 24h;
      add_header X-Cache-Status $upstream_cache_status always;
    }
    
    #--------------------------------------------------------------------------
    # BUILDS DIRECTORY
    #--------------------------------------------------------------------------
    location /builds {
      alias /var/www/app/hosting/builds/;
      autoindex on;
      
      access_log off;
      
      add_header Cache-Control "public, max-age=1800";
      add_header Access-Control-Allow-Origin "*" always;
      add_header Access-Control-Allow-Methods "GET, OPTIONS" always;
      
      proxy_cache STATIC;
      proxy_cache_valid 200 30m;
      add_header X-Cache-Status $upstream_cache_status always;
    }
    
    #--------------------------------------------------------------------------
    # ARENA CONTENT
    #--------------------------------------------------------------------------
    location ~ ^/arenas/([^/]+)/(.+)$ {
      alias /var/www/app/hosting/arenas/$1/$2;
      
      access_log off;
      
      add_header Cache-Control "public, max-age=900";
      add_header Access-Control-Allow-Origin "*" always;
      add_header Access-Control-Allow-Methods "GET, OPTIONS" always;
      
      proxy_cache STATIC;
      proxy_cache_valid 200 15m;
      add_header X-Cache-Status $upstream_cache_status always;
    }
    
    #--------------------------------------------------------------------------
    # BACKEND API - SERVER LIST
    #--------------------------------------------------------------------------
    location /server_list_json {
      proxy_pass https://127.0.0.1:8420;
      
      # SSL settings for local backend
      proxy_ssl_verify off;
      proxy_ssl_session_reuse on;
      proxy_http_version 1.1;
      
      # Proxy headers
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
      
      # CORS headers
      add_header Access-Control-Allow-Origin "*" always;
      add_header Access-Control-Allow-Methods "GET, POST, OPTIONS" always;
      
      # Handle preflight requests
      if ($request_method = OPTIONS) {
        add_header Access-Control-Max-Age 1728000;
        add_header Content-Length 0;
        add_header Content-Type text/plain;
        return 204;
      }
    }
    
    #--------------------------------------------------------------------------
    # APPLICATION PROXY (DEFAULT)
    #--------------------------------------------------------------------------
    location / {
      proxy_pass http://127.0.0.1:3000;
      proxy_http_version 1.1;
      
      # Proxy headers
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
      
      # Dynamic CORS handling based on URI
      if ($cors_origin = "*") {
        add_header Access-Control-Allow-Origin "*" always;
        add_header Access-Control-Allow-Methods "GET, POST, OPTIONS" always;
        add_header Access-Control-Allow-Headers "Authorization, Content-Type" always;
      }
      
      # Handle preflight requests
      if ($is_options = 1) {
        add_header Access-Control-Max-Age 1728000;
        add_header Content-Length 0;
        add_header Content-Type text/plain;
        return 204;
      }
    }
  }
  
  ##############################################################################
  # HTTP TO HTTPS REDIRECT
  ##############################################################################
  server {
    listen 80;
    listen [::]:80;
    
    server_name hypersomnia.io www.hypersomnia.io;
    
    access_log off;
    
    return 301 https://hypersomnia.io$request_uri;
  }
}