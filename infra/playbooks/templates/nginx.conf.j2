# nginx/1.26.3
user ubuntu;
worker_processes auto;

events {
    worker_connections 4096;
    use epoll;
}

http {
    include mime.types;
    default_type application/octet-stream;
    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    etag on;

    # gzip compression
    gzip on;
    gzip_comp_level 5;
    gzip_min_length 1000;
    gzip_types text/plain text/css application/javascript text/xml application/xml text/javascript image/x-icon;
    gzip_vary on;
    gzip_disable msie6;
    gzip_static on;

    # RAM cache
    proxy_cache_path /var/cache/nginx levels=1:2 keys_zone=STATIC:512m inactive=24h max_size=2g;

    # open_file_cache
    open_file_cache max=10000 inactive=60s;
    open_file_cache_valid 30s;
    open_file_cache_min_uses 2;
    open_file_cache_errors on;

    # CORS mapping
    map $request_uri $cors {
        default "";
        ~^/leaderboards\?format=json "*";
        ~^/arenas\?format=json "*";
        /upload "*";
        /revoke_discord "*";
        /geolocation "*";
    }
    map $request_method $is_options { default 0; OPTIONS 1; }

    # -------------------------------
    # Main HTTPS server
    # -------------------------------
    server {
        listen 443 ssl http2 reuseport;
        listen [::]:443 ssl http2 reuseport;
        listen 443 quic reuseport;
        listen [::]:443 quic reuseport;
        server_name {{ domains.hub }} www.{{ domains.hub }};

        ssl_certificate /etc/letsencrypt/live/{{ domains.hub }}/fullchain.pem;
        ssl_certificate_key /etc/letsencrypt/live/{{ domains.hub }}/privkey.pem;
        ssl_session_cache shared:le_nginx_SSL:10m;
        ssl_session_timeout 1440m;
        ssl_session_tickets off;
        ssl_protocols TLSv1.2 TLSv1.3;
        ssl_ciphers "ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384";
        ssl_prefer_server_ciphers off;
        add_header Alt-Svc 'h3=":443"; ma=86400' always;
        client_max_body_size 25M;

        # Security headers
        add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;
        add_header X-Content-Type-Options "nosniff" always;
        add_header X-Frame-Options "SAMEORIGIN" always;
        add_header X-XSS-Protection "1; mode=block" always;

        # Redirect non-apex hosts to apex
        if ($host != "{{ domains.hub }}") { return 301 https://{{ domains.hub }}$request_uri; }

        # -------------------------------
        # Exact redirects
        # -------------------------------
        location = /press   { return 301 https://github.com/TeamHypersomnia/PressKit/blob/main/README.md#intro; }
        location = /credits { return 301 https://teamhypersomnia.github.io/PressKit/credits; }
        location = /steam   { return 301 https://store.steampowered.com/app/2660970/Hypersomnia/; }
        location = /discord { return 301 https://discord.com/invite/YC49E4G; }

        # -------------------------------
        # ZIP files
        # -------------------------------
        location ~* \.zip$ {
            root /var/www/html;
            default_type application/zip;
            add_header Content-Disposition "attachment";
        }

        # -------------------------------
        # Assets + favicon + robots
        # -------------------------------
        location ~ ^/(assets/.*|favicon\.ico|robots\.txt)$ {
            alias /var/www/app/public/$1;
            proxy_cache STATIC;
            proxy_cache_valid 200 24h;
            access_log off;
            add_header Cache-Control "public, max-age=31536000";
            add_header Access-Control-Allow-Origin * always;
            add_header Access-Control-Allow-Methods "GET, OPTIONS" always;
            add_header X-Cache-Status $upstream_cache_status always;
        }

        # -------------------------------
        # Builds
        # -------------------------------
        location /builds {
            alias {{ paths.builds }}/;
            autoindex on;
            access_log off;
            proxy_cache STATIC;
            proxy_cache_valid 200 30m;
            add_header Access-Control-Allow-Origin * always;
            add_header Access-Control-Allow-Methods "GET, OPTIONS" always;
            add_header X-Cache-Status $upstream_cache_status always;
        }

        # -------------------------------
        # Arenas
        # -------------------------------
        location ~ ^/arenas/([^/]+)/(.+)$ {
            alias /var/www/app/hosting/arenas/$1/$2;
            access_log off;
            proxy_cache STATIC;
            proxy_cache_valid 200 15m;
            add_header Cache-Control "public, max-age=900";
            add_header Access-Control-Allow-Origin * always;
            add_header Access-Control-Allow-Methods "GET, OPTIONS" always;
            add_header X-Cache-Status $upstream_cache_status always;
        }

        # -------------------------------
        # SPA fallback
        # -------------------------------
        location / {
            proxy_pass http://127.0.0.1:3000;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection 'upgrade';
            proxy_set_header Host $host;
            proxy_cache_bypass $http_upgrade;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            if ($cors = "*") {
                add_header Access-Control-Allow-Origin * always;
                add_header Access-Control-Allow-Methods "GET, POST, OPTIONS" always;
                add_header Access-Control-Allow-Headers "Authorization,Content-Type" always;
            }
            if ($is_options) { add_header Access-Control-Max-Age 1728000; return 204; }
        }

        error_log /var/log/nginx/error.log crit;
        access_log /var/log/nginx/access.log;
    }

    # -------------------------------
    # HTTP â†’ HTTPS redirect
    # -------------------------------
    server {
        listen 80;
        listen [::]:80;
        server_name {{ domains.hub }} www.{{ domains.hub }};

        return 301 https://{{ domains.hub }}$request_uri;
        error_log /var/log/nginx/error.log crit;
        access_log off;
    }
}
